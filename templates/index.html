<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{{ url_for('static', filename= 'css/style.css') }}">
    <title>FlaskBlog</title>
</head>
<section class="msger">
  <header class="msger-header">
    <div class="msger-header-title">
      <i class="fas fa-comment-alt"></i> –ß–∞—Ç
    </div>
    <div class="ui toggle checkbox">
    </div>
    <p><select id="model" name="model">
    {% for file in files %}
        <option value="{{file}}">{{file}}</option>
    {% endfor %}
    </select></p>
    <div class="msger-header-options">
      <span><i class="fas fa-cog"></i></span>
    </div>
  </header>

  <main class="msger-chat">
    <div class="msg left-msg">
      <div
       class="msg-img"
       style="background-image: url(https://image.flaticon.com/icons/svg/327/327779.svg)"
      ></div>

      <div class="msg-bubble">
        <div class="msg-info">
          <div class="msg-info-name">–î–æ–º–æ–≤–æ–π</div>
          <div class="msg-info-time">12:45</div>
        </div>

        <div class="msg-text">
            –ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –ø–æ –ø—Ä–æ–±–ª–µ–º–µ  üòÑ
        </div>
      </div>
    </div>
{% for message in messages %}
	
{% endfor %}

  </main>

  <form id="form" class="msger-inputarea">
    <input id="text" type="text" class="msger-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
    {% if server_enabled %}
    <button id="sent-button" type="submit" class="msger-send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    {% else %}
    <button id="sent-button" type="submit" class="msger-send-btn" disabled >–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    {% endif %}
    
    
  </form>
</section>
<script>

const msgerForm = get(".msger-inputarea");
const msgerInput = get(".msger-input");
const msgerChat = get(".msger-chat");

const BOT_MSGS = [
  "Hi, how are you?",
  "Ohh... I can't understand what you trying to say. Sorry!",
  "I like to play games... But I don't know how to play!",
  "Sorry if my answers are not relevant. :))",
  "I feel sleepy! :("
]

const BOT_IMG = "https://image.flaticon.com/icons/svg/327/327779.svg";
const PERSON_IMG = "https://image.flaticon.com/icons/svg/145/145867.svg";
const BOT_NAME = "–î–æ–º–æ–≤–æ–π";
const PERSON_NAME = "–í—ã";

const sendBtm = document.getElementById('sent-button');
const messageForm = document.getElementById('form');

const socket = new WebSocket('ws://' + location.host + '/echo');

const lastMessage = "–°–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –∑–∞—è–≤–∫–∞:<br>–°–ª–æ–º–∞–ª—Å—è —Ñ–æ–Ω–∞—Ä—å<br> –ê–¥—Ä–µ—Å: 8-—è —É–ª–∏—Ü–∞ –°–æ–∫–æ–ª–∏–Ω–æ–π –ì–æ—Ä—ã, –¥–æ–º 3<br> –ö–∞—Ç–µ–≥–æ—Ä–∏—è: —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ<br>–í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–∫–∞–∑–∞–Ω–∞ –≤–µ—Ä–Ω–æ?";

let count = 1;

socket.addEventListener('message', ev => {
    count++;
    const message = ev.data;

    if (count === 4) {
        appendLastMessage(BOT_NAME, BOT_IMG, "left", ev.data);
    } else { 
        appendMessage(BOT_NAME, BOT_IMG, "left", ev.data);
    }

    sendBtm.disabled = false;
});

messageForm.onsubmit = (ev) => {
    ev.preventDefault();

    const textField = document.getElementById('text');
    const model = document.getElementById('model');

    appendMessage(PERSON_NAME, PERSON_IMG, "right", textField.value);

    sendBtm.disabled = true
    const dict = "false" + " " + model.value + " " + textField.value;
    socket.send(dict);

    textField.value = '';
};

function appendMessage(name, img, side, text) {
  const msgHTML = `
    <div class="msg ${side}-msg">
      <div class="msg-img" style="background-image: url(${img})"></div>

      <div class="msg-bubble">
        <div class="msg-info">
          <div class="msg-info-name">${name}</div>
          <div class="msg-info-time">${formatDate(new Date())}</div>
        </div>

        <div class="msg-text">${text}</div>
      </div>
    </div>
  `;

  msgerChat.insertAdjacentHTML("beforeend", msgHTML);
  msgerChat.scrollTop += 500;
}

function onYesClick() {
    if (window.AndroidInterface) {
      window.AndroidInterface.onProblemTitleChange("–°–ª–æ–º–∞–ª—Å—è —Ñ–æ–Ω–∞—Ä—å");
      window.AndroidInterface.onProblemDescriptionChange("–û–∫–æ–ª–æ –¥–æ–º–∞ —Å–ª–æ–º–∞–ª—Å—è —Ñ–æ–Ω–∞—Ä—å");
      window.AndroidInterface.createProblem();
    }
}

function appendLastMessage(name, img, side, text) {
    const msgHTML = `
    <div class="msg ${side}-msg">
      <div class="msg-img" style="background-image: url(${img})"></div>

      <div class="msg-bubble">
        <div class="msg-info">
          <div class="msg-info-name">${name}</div>
          <div class="msg-info-time">${formatDate(new Date())}</div>
        </div>

        <div class="msg-text">${text}</div>

         <button class="msg-control" onclick="onYesClick()"">
            <div class="msg-control-yes">–î–∞, –≤—Å–µ –≤–µ—Ä–Ω–æ</div>
        </button>
      </div>
    </div>
  `;

  msgerChat.insertAdjacentHTML("beforeend", msgHTML);
  msgerChat.scrollTop += 500;
}


// Utils
function get(selector, root = document) {
  return root.querySelector(selector);
}

function formatDate(date) {
  const h = "0" + date.getHours();
  const m = "0" + date.getMinutes();

  return `${h.slice(-2)}:${m.slice(-2)}`;
}

</script>
</body>
</html>
